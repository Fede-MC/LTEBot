<!-- INICIO DEL CÓDIGO DEL CHATBOT TUTOR VIRTUAL (AVATAR FINAL) -->
<style>
    :root{--bot-primary-color:#005a9e;--bot-secondary-color:#f4f4f4;--bot-text-color:#333;--bot-header-text-color:#fff;--bot-message-user-bg:#dcf8c6}
    .chatbot-container{position:fixed;bottom:25px;left:25px;z-index:9999}
    #chatbot-toggle{width:70px;height:70px;border-radius:50%;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:transform .2s ease;background-color:var(--bot-primary-color);display:flex;justify-content:center;align-items:center}
    #chatbot-toggle:hover{transform:scale(1.1)}
    #chatbot-toggle svg{width:48px;height:48px;fill:#fff}
    #chatbot-window{position:fixed;bottom:110px;left:25px;width:370px;max-width:90vw;height:550px;max-height:calc(90vh - 100px);background-color:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow:hidden;opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;pointer-events:none}
    #chatbot-window.open{opacity:1;transform:translateY(0);pointer-events:auto}
    #chatbot-header{background-color:var(--bot-primary-color);color:var(--bot-header-text-color);padding:15px;font-weight:700;font-size:1.1em;text-align:center;border-top-left-radius:15px;border-top-right-radius:15px;position:relative}
    #chatbot-messages{flex-grow:1;padding:20px;overflow-y:auto;background-color:var(--bot-secondary-color)}
    .chat-message{padding:10px 15px;border-radius:18px;margin-bottom:2px;max-width:85%;line-height:1.45;word-wrap:break-word;font-size:.95em}
    .bot-message-wrapper{display:flex;align-items:flex-end;margin-bottom:12px;max-width:95%}
    .bot-avatar{width:40px;height:40px;border-radius:50%;margin-right:10px;flex-shrink:0;background:var(--bot-primary-color);display:flex;justify-content:center;align-items:center;overflow:hidden;padding:5px}
    .bot-avatar svg{width:100%;height:100%;fill:var(--bot-header-text-color)}
    .bot-message{background-color:#fff;color:var(--bot-text-color);border-bottom-left-radius:5px}
    .user-message{background-color:var(--bot-message-user-bg);color:var(--bot-text-color);border-bottom-right-radius:5px;margin-left:auto}
    .user-message-wrapper{display:flex;justify-content:flex-end;margin-bottom:12px}
    #chatbot-input-form{display:flex;padding:10px;border-top:1px solid #ddd;background:#fff}
    #chatbot-input{flex-grow:1;border:1px solid #ccc;border-radius:20px;padding:10px 15px;outline:none;font-size:1em}
    #chatbot-send-btn{background:0 0;border:none;cursor:pointer;padding:0 10px;fill:var(--bot-primary-color)}
</style>

<div class="chatbot-container">
    <div id="chatbot-window">
        <div id="chatbot-header">Tutor Virtual</div>
        <div id="chatbot-messages"></div>
        <form id="chatbot-input-form">
            <input type="text" id="chatbot-input" placeholder="Pregúntame sobre el curso..." autocomplete="off">
            <button id="chatbot-send-btn" type="submit">
                <svg viewBox="0 0 24 24" width="24" height="24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </form>
    </div>
    <div id="chatbot-toggle"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const BOT_NAME = 'Tutor Virtual';
    let botState = { userName: null, awaitingName: true, pendingAction: null };

    // --- NUEVO AVATAR SVG EMBEBIDO ---
    const botAvatarSVG = `<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
<g fill="currentColor">
<path d="M113.2,53.16c0-26.1-21.3-47.4-47.4-47.4H54.2c-26.1,0-47.4,21.3-47.4,47.4v13.6c0,10.2,8.4,18.6,18.6,18.6h7.2v7.8 c0,10.2,8.4,18.6,18.6,18.6h22.8c10.2,0,18.6-8.4,18.6-18.6v-7.8h7.2c10.2,0,18.6-8.4,18.6-18.6V53.16z M33.8,55.86 c-4.8,0-8.4-3.6-8.4-8.4s3.6-8.4,8.4-8.4s8.4,3.6,8.4,8.4S38.6,55.86,33.8,55.86z M86.6,55.86c-4.8,0-8.4-3.6-8.4-8.4 s3.6-8.4,8.4-8.4s8.4,3.6,8.4,8.4S91.4,55.86,86.6,55.86z"/>
<text x="60" y="82" font-family="Arial, sans-serif" font-weight="bold" font-size="20" text-anchor="middle" fill="var(--bot-primary-color)">GRDIA</text>
</g></svg>`;
    
    const courseData = {
        general: { courseName: "Gestión de recursos digitales con IA generativa", degree: "Licenciatura en Tecnologías Educativas", director: "Lic. Marcelo Fraire", mainProfessor: "Mag. Lic. Mónica Leda Torres", startDate: "4 de agosto de 2025" },
        evaluation: { approval: "Para aprobar la cursada necesitas participar en al menos el 75% de los foros y realizar la totalidad de los parciales o sus respectivos recuperatorios.", promotion: "Para promocionar (no rendir final), necesitas una calificación final de 8 (ocho) o más puntos, promediando todas las actividades.", finalExam: "Si tu calificación es de 6 (seis) o 7 (siete) puntos, deberás rendir un examen final y aprobarlo con 6 o más puntos.", retakeCourse: "Si tu calificación es de 5 (cinco) o menos, o si no rendiste uno o más parciales (o sus recuperatorios), deberás recursar la materia." },
        units: [ { id: 1, title: "Introducción a la IA", period: "4/8 al 10/8", activities: "Foro de debate (cierra 10/8), Cuestionario (cierra 9/8)." }, { id: 2, title: "Creación de texto con IA", period: "11/8 al 24/8", activities: "Foro de debate (cierra 17/8), Trabajo Práctico (cierra 23/8)." }, { id: 3, title: "Creación de imágenes con IA", period: "25/8 al 7/9", activities: "Foro de debate (cierra 31/8), Trabajo Práctico (cierra 6/9)." }, { id: 4, title: "Producción de audio con IA - Podcasting", period: "8/9 al 21/9", activities: "Foro de debate (cierra 14/9), Trabajo Práctico (cierra 19/9)." }, { id: 5, title: "Video digital con IA", period: "22/9 al 12/10", activities: "Foro de debate (cierra 28/9), Trabajo Práctico (cierra 11/10)." }, { id: 6, title: "Espacios digitales enriquecidos con IA", period: "13/10 al 26/10", activities: "Foro de debate (cierra 19/10), Cuestionario (cierra 24/10)." }, { id: 7, title: "TIF - Parte I", period: "27/10 al 14/11", activities: "Trabajo Práctico (TIF I) entrega hasta el 11/11." } ],
        exams: [ { name: "Primer Parcial", date: "Del 20/9 al 21/9", retakeDate: "23/9" }, { name: "Segundo Parcial (TIF II)", date: "Hasta el 12/11", retakeDate: "14/11" } ],
        emotionalSupport: [ "Lamento mucho que te sientas así, {NAME}. Es totalmente válido sentirse abrumado a veces. Recuerda que avanzar paso a paso es un gran logro. ¿Quieres que revisemos juntos el cronograma para que puedas organizar mejor tus tiempos?", "Te entiendo, {NAME}. A veces la frustración es parte del camino, pero no define tu capacidad. Tómate un respiro. Si necesitas hablar o buscar otra perspectiva, no dudes en contactar al equipo docente. ¡Están para apoyarte!", "Comprendo que te sientas así, {NAME}. Quiero recordarte que está bien no poder con todo a la vez. Cada esfuerzo cuenta. Si necesitas una mano, el equipo docente está a tu disposición para conversar. ¡Mucho ánimo!" ]
    };

    const affirmativeKeywords = ['sí', 'si', 'dale', 'bueno', 'ok', 'por favor', 'claro'];
    const unitSpecificRegex = /(unidad|unidades|módulo|modulos|tema|temas|la)?\s*(\d+)/;
    const unitGeneralRegex = /^(unidades|módulos|temas)$/;
    const emotionalKeywords = ['ansiedad', 'estresado', 'frustrado', 'no puedo', 'desmotivado', 'preocupado', 'agobiado', 'difícil', 'dificil', 'desanimado'];
    
    const intents = [
        { name: 'get_specific_unit_info', matcher: (input) => unitSpecificRegex.test(input), handler: (input) => { const match = input.match(unitSpecificRegex); const unitNumber = parseInt(match[2], 10); const unit = courseData.units.find(u => u.id === unitNumber); if (unit) { return `¡Claro, ${botState.userName}! Aquí tienes la info de la <b>Unidad ${unit.id}: ${unit.title}</b>:<br>- <b>Período:</b> ${unit.period}.<br>- <b>Actividades:</b> ${unit.activities}`; } return `Busqué la unidad ${unitNumber}, ${botState.userName}, pero no la encontré. Las unidades van de la 1 a la 7. ¿Quieres probar con otro número?`; } },
        { name: 'get_all_units_summary', matcher: (input) => unitGeneralRegex.test(input), handler: () => { let r = `¡Claro, ${botState.userName}! Aquí tienes un resumen de todas las unidades del curso. Si quieres más detalles de alguna, solo dime el número.<br><br>`; courseData.units.forEach(u => { r += `<b>- Unidad ${u.id}:</b> ${u.title}<br>`; }); return r; } },
        { name: 'get_exam_dates', matcher: (input) => ['parcial', 'examen', 'evaluacion', 'tif ii'].some(kw => input.includes(kw)), handler: () => { let r = `¡Por supuesto, ${botState.userName}! Te detallo la información sobre las evaluaciones:<br><br>`; courseData.exams.forEach(e => { r += `<b>${e.name}:</b><br>Fecha: ${e.date}.<br>Recuperatorio: ${e.retakeDate}.<br><br>`; }); return r; } },
        { name: 'get_retake_dates', matcher: (input) => ['recuperatorio', 'recuperar'].some(kw => input.includes(kw)), handler: () => { let r=`Las fechas de los recuperatorios principales son:<br><br>`; courseData.exams.forEach(e => {r+=`<b>${e.name}:</b> ${e.retakeDate}.<br>`}); r+="<br>También hay recuperatorios para algunos cuestionarios."; return r; }},
        { name: 'get_approval_criteria', matcher: (input) => ['aprobar', 'aprobacion', 'cursada', 'regularizar'].some(kw => input.includes(kw)), handler: () => courseData.evaluation.approval },
        { name: 'get_promotion_criteria', matcher: (input) => ['promocionar', 'promocion'].some(kw => input.includes(kw)), handler: () => courseData.evaluation.promotion },
        { name: 'get_start_date', matcher: (input) => ['inicio', 'inicia', 'empezamos', 'arranca', 'cuando'].some(kw => input.includes(kw)), handler: () => `¡Qué buena pregunta, ${botState.userName}! El curso inicia el <b>${courseData.general.startDate}</b>.`},
        { name: 'greet', matcher: (input) => ['hola', 'buenas', 'buen dia'].some(kw => input.includes(kw)), handler: () => `¡Hola de nuevo, ${botState.userName}! ¿En qué más puedo ayudarte hoy?` },
        { name: 'farewell', matcher: (input) => ['gracias', 'adios', 'chau'].some(kw => input.includes(kw)), handler: () => `De nada, ${botState.userName}. ¡Mucho éxito en la cursada!` }
    ];

    const chatbotWindow = document.getElementById('chatbot-window');
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInputForm = document.getElementById('chatbot-input-form');
    
    chatbotToggle.innerHTML = botAvatarSVG;

    chatbotToggle.addEventListener('click', () => chatbotWindow.classList.toggle('open'));

    chatbotInputForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const userInput = document.getElementById('chatbot-input').value.trim();
        if (userInput === '') return;
        addMessage(userInput, 'user');
        document.getElementById('chatbot-input').value = '';
        if (botState.awaitingName) { handleNameInput(userInput); } 
        else { setTimeout(() => { addMessage(findResponse(userInput.toLowerCase()), 'bot'); }, 500); }
    });
    
    function handleNameInput(name) {
        botState.userName = name.split(' ')[0].replace(/[^a-zA-ZáéíóúÁÉÍÓÚ]/g, '');
        botState.userName = botState.userName.charAt(0).toUpperCase() + botState.userName.slice(1);
        botState.awaitingName = false;
        setTimeout(() => { addMessage(`¡Un gusto, ${botState.userName}! Soy tu Tutor Virtual. Puedes preguntarme por fechas de parciales, detalles de las unidades o criterios de evaluación.`, 'bot'); }, 400);
    }
    
    function addWelcomeMessage() { addMessage('¡Hola! Soy tu Tutor Virtual. Para que nuestra conversación sea más amena, ¿me dirías tu nombre?', 'bot'); }

    function addMessage(text, sender) {
        let messageWrapper;
        if (sender === 'bot') {
            messageWrapper = document.createElement('div');
            messageWrapper.className = 'bot-message-wrapper';
            const avatar = document.createElement('div');
            avatar.className = 'bot-avatar';
            avatar.innerHTML = botAvatarSVG;
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message bot-message';
            messageElement.innerHTML = text;
            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageElement);
        } else {
            messageWrapper = document.createElement('div');
            messageWrapper.className = 'user-message-wrapper';
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message user-message';
            messageElement.innerHTML = text;
            messageWrapper.appendChild(messageElement);
        }
        chatbotMessages.appendChild(messageWrapper);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function findResponse(userInput) {
        if (botState.pendingAction && affirmativeKeywords.some(kw => userInput.startsWith(kw))) {
            const action = botState.pendingAction;
            botState.pendingAction = null;
            if (action === 'offer_schedule') { return intents.find(i => i.name === 'get_all_units_summary').handler(); }
        }
        botState.pendingAction = null;
        if (emotionalKeywords.some(kw => userInput.includes(kw))) {
            botState.pendingAction = 'offer_schedule';
            const randomResponse = courseData.emotionalSupport[Math.floor(Math.random() * courseData.emotionalSupport.length)];
            return randomResponse.replace('{NAME}', botState.userName);
        }
        for (const intent of intents) {
            if (intent.matcher(userInput)) { return intent.handler(userInput); }
        }
        return `Disculpa ${botState.userName}, no encontré información exacta sobre eso. Puedes preguntar por "parciales", "unidades", o consultar sobre una unidad específica como "unidad 3".`;
    }
    
    addWelcomeMessage();
});
</script>
<!-- FIN DEL CÓDIGO DEL CHATBOT TUTOR VIRTUAL -->